---
title: "TABLE ONE AND PLOTS"
author: "Asabere Asante"
df-print: kable
code-overflow: wrap
execute:
  echo: true
  warning: false
  message: false
format: 
  html:
    embed-resources: true
    fig-width: 8
    fig-height: 6
    dpi: 300
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
 library(MASS)
library(tidyverse)
library(finalfit)
library(gtsummary)
library(patchwork)
library(broom)
#library(conflicted)
library(gt)
#conflict_prefer("select", "dplyr")
```

```{r}
rakai = read_csv("rakai_updated.csv")
dim(rakai)
#glimpse(rakai)
#missing_glimpse(rakai)

```

```{r}
df1 <- rakai %>% 
  select(ageyrs,sex,locate,occup1,currmarr,evermarr,mobility,
          artdays,artwks,artmos,artyrs,comm_num,educyrs,religion)
```

```{r}
df2 <- rakai %>% 
  select(ageyrs,sex,locate,occup1,currmarr,evermarr,mobility,
  artdays,artwks,artmos,artyrs,comm_num,artrunbc,artstrbc,hivac,copies,new_copies)

```

```{r}



```

```{r}
df3 <- df1 %>% 
  mutate(ageyrs = ageyrs %>%  ff_label("Age (years)"),
         sex = if_else(sex == "F","Female","Male") %>% 
           as_factor() %>%
           fct_relevel("Female") %>% 
           ff_label("Sex"),
         mobility = case_when(
           mobility %in% c(3,8,10) ~ "In-migrant",
           .default = "Long-term resident") %>% 
           fct_relevel("In-migrant") %>% 
           ff_label("Migration"),
         community_type = case_when(
           comm_num %in% c(38,770,771,774) ~ "Fishing community",
                                     .default = "Inland Community") %>% 
           fct_relevel("Inland Community") %>% 
           ff_label("Community type"),
         fishing_comm = if_else(community_type == "Fishing Community",1,0) %>% 
           ff_label("Lake Victoria Fishing Community"),
         
         primary_occupation = case_when(
           occup1 %in% c(1,2,5) ~ "Agriculture/Homebrewing",
           occup1 %in% c(10,11) ~ "Trading or shopkeeping",
           occup1 %in% c(12,18) ~ "Bar work or waitressing",
           occup1 %in% c(2,3,4) ~ "House work",
           occup1  == 7 ~ "Fishing-related occupation",
           .default = "Other") %>% 
           fct_relevel("Agriculture/Homebrewing","Trading or shopkeeping") %>% 
           ff_label("Primary Occupation"),
         
         age_cat = case_when(
                             ageyrs < 30 ~ "<30",
                             ageyrs >= 30 & ageyrs <= 39 ~  "30-39",
                             ageyrs >=40 & ageyrs <= 49 ~ "40-49") %>% 
           fct_relevel("<30") %>% 
           ff_label("Age group"),
         
         current_marital_status = case_when(
           currmarr == 1 ~ "Currently married",
           currmarr == 2 ~ "Previously married",
           currmarr == 8 ~ "Never married"
           ) %>% 
           fct_relevel("Never married","Currently married") %>% 
           ff_label("Current marital status"),
         
         art_duration = case_when(
           artyrs >= 1 & artyrs < 2 ~ "1-2 years",
           artyrs > 2 &  artyrs <= 5 ~ "2-5 years",
           artyrs > 5 ~ ">5 years",
           .default =  "<1 year"
         ) %>% 
           fct_relevel("<1 year","1-2 years","2-5 years") %>% 
           ff_label("Time on ART"),
         
         education_level = case_when(
           educyrs == 8 ~ "No formal education",
           educyrs %in% c(1,2) ~ "Primary",
           educyrs %in% c(3,4) ~ "Secondary",
           educyrs %in% c(5,6,7,10,11) ~ "Technical/University"
          
          ) %>% 
           fct_relevel("No formal education") %>% 
           ff_label("Educational attainment"),
         
         religion = case_when(
           religion %in% c(1,6) ~ "Other or none",
           religion %in% c(2,3,4) ~ "Catholic/Christian",
           religion == 5 ~ "Muslim"
         ) %>% 
           ff_label("Religion")
                                    
         
  )

# saveRDS(df3, file = "rakai_cleaned.rds")

```

```{r}
df4 <- df3 %>% 
  select(
    ageyrs,age_cat,sex,current_marital_status,education_level,primary_occupation,
    mobility,community_type,art_duration
  )

```

### **Table One**

```{r}
df4 %>%
  tbl_summary(
    by = sex,
    statistic = list(
      all_categorical() ~ "{n} ({p}%)",
      all_continuous()  ~ "{median} ({IQR})"
    ),
    digits = list(
      all_categorical() ~ 0,
      all_continuous()  ~ 0
    )
  ) %>%
  add_overall() %>%
   bold_labels() %>%
  italicize_levels() %>%
  modify_spanning_header(
     all_stat_cols() ~ "**Sex**"
  ) 
```

```{r}
df5 <- rakai %>% 
  select(sex,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8)
```

```{r}
df6 <- df5 %>% 
  mutate(
    sex = if_else(sex == "F","Female","Male") %>% 
      as_factor() %>%
      fct_relevel("Female") %>% 
      as_factor() %>% 
      ff_label("Sex"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  )
```

### **Viral Load Suppression**

```{r}
df7 <- df6 %>% filter(copies != "INV.IC ",!is.na(copies),!is.na(new_copies)) %>% 
  mutate(
    copies = str_remove_all(copies, "<\\s*"),
    copies = if_else(copies == "BD", "0", copies),
    copies = as.numeric(copies),
    
    new_copies = str_remove_all(new_copies, "<\\s*"),
    new_copies = if_else(new_copies == "BD", "0", new_copies),
    new_copies = as.numeric(new_copies)
  ) %>% 
  mutate(viral_load_b4 = if_else(copies < 200, "Viral Load Sppression","Viraemia") %>% 
           ff_label("HIV RNA viral load, in copies/ml"),
         viral_load_after = if_else(new_copies < 200,"Viral Load Sppression","Viraemia") %>% 
           ff_label("HIV RNA viral load, in copies/ml"))


```

```{r}
df_vl_supp  <- df7 %>%
  mutate(
    suppbc = if_else(viral_load_b4 == "Viral Load Suppression", 1, 0),
    suppac = if_else(viral_load_after == "Viral Load Suppression", 1, 0)
  ) %>% 
  select(-c(copies,new_copies))%>% 
  pivot_longer(
    cols = c(viral_load_b4,viral_load_after),
    names_to = "variable",
    values_to = "viral_load"
  ) %>%
  mutate(
    time = if_else(grepl("b4$", variable), "Before Covid-19", "After Covid-19"),
  )


  
  
df_vl_summary <- df_vl_supp %>% filter(!is.na(viral_load)) %>% 
  group_by(time,viral_load) %>%
  summarise(
    n_suppressed = n(),
    .groups = "drop"
  ) %>% 
  mutate(time = as_factor(time) %>%  fct_relevel("Before Covid-19"),
         viral_load = as_factor(viral_load) %>% 
           fct_relevel("Viral Load Suppression"))

df_vl_summary <-  df_vl_summary %>% 
  group_by(time) %>% 
  summarise(n = sum(n_suppressed)) %>% 
  left_join(df_vl_summary,join_by(time))

df_vl_summary <- df_vl_summary  %>%
  mutate(
    proportion = n_suppressed / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) 
df_vl_summary
```

```{r}
ggplot(df_vl_summary, aes(x = viral_load, y = proportion, fill = time)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = 0.7),
    width = 0.5
  ) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 0.5
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Viral Load", 
       y = "Proportion of individuals", 
       fill = "Time",
       title = "Viral Load Levels") +
  
  theme_minimal()+
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

```

### **Proportion taking ART pills less frequently / in smaller amounts by Sex**

```{r}
df6 %>% group_by(sex,artstrbc) %>% 
  count()

df6 %>% group_by(sex,artstrac) %>% 
  count()
```

```{r}
df_artstr <- df6 %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_artstr_summary <- df_artstr %>%
  group_by(time,sex) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_artstr_totals <- df_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_artstr_summary <- bind_rows(df_artstr_summary, df_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         sex= if_else(is.na(sex),"Total",sex))



df_artstr_summary <-  df_artstr_summary %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    sex = as_factor(sex)
  )



```

```{r}
reduced_art_intake_plot <- ggplot(df_artstr_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20))+
  labs(
    title = "Reduced ART Intake",
    x = "Sex",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

reduced_art_intake_plot

```

### **Run out of ART before next refill by Sex**

```{r}
df6 %>% group_by(sex,artrunbc) %>% 
  count()

df6 %>% group_by(sex,artrunac) %>% 
  count()

```

```{r}

df_artrun <- df6 %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19"),
    variable = "Run out of ART before next refill"
  )


df_artrun_summary <- df_artrun %>%
  group_by(time,sex) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_artrun_totals <- df_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )
 

df_artrun_totals

df_artrun_summary <- bind_rows(df_artrun_summary, df_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
        sex= if_else(is.na(sex),"Total",sex))


df_artrun_summary <-  df_artrun_summary %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    sex = as_factor(sex)
  )
```

```{r}
run_out_of_art_plot <- ggplot(df_artrun_summary, aes(x = sex, y = proportion,fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20)) +
  labs(
    title = "Run Out of ART",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
run_out_of_art_plot


```

### **Missed Scheduled Visits by Sex**

```{r}
df6 %>% group_by(sex,hivbc) %>% 
  count()

df6 %>% group_by(sex,hivac) %>% 
  count()
```

```{r}
df_hiv <- df6 %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19"),
    variable = "Missed Scheduled Visits"
  )

df_hiv_summary <- df_hiv %>%
  group_by(time,sex) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_hiv_totals <- df_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_hiv_summary <- bind_rows(df_hiv_summary, df_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         sex= if_else(is.na(sex),"Total",sex))



df_hiv_summary <-  df_hiv_summary %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    sex = as_factor(sex)
  )
```

```{r}
missed_scheduled_visit_plot <-  ggplot(df_hiv_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

missed_scheduled_visit_plot

```

### Combined Plots

```{r}
ps1 <- ggplot(df_hiv_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
ps1 ## Missed scheduled visits
```

```{r}
### Reduced pill intake
ps2 <- ggplot(df_artstr_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20))+
  labs(
    title = " Reduced ART Intake",
    x = "Sex",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
   legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
ps2

```

```{r}
## Run out of pills
ps3 <- ggplot(df_artrun_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20)) +
  labs(
    title =  "Run Out of ART",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title =  element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

ps3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(ps1 + ps2)/ps3
```

# SUBPLOTS

### Community Type

```{r}
df_com <-  rakai %>% 
  select(comm_num,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
  mutate(
    community_type = case_when(
      comm_num %in% c(38,770,771,774) ~ "Fishing community",
      .default = "Inland Community") %>% 
      fct_relevel("Inland Community") %>% 
      ff_label("Community type"),

    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  ) %>% 
  select(-comm_num)



```

```{r}
 # df_com
```

### Reduced ART intake by Community

```{r}
df_com %>% group_by(community_type,artstrbc) %>% 
  count()

df_com %>% group_by(community_type,artstrac) %>% 
  count()
```

```{r}
df_com_artstr <- df_com %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_com_artstr_summary <- df_com_artstr %>%
  group_by(time,community_type) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_artstr_totals <- df_com_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_com_artstr_summary <- bind_rows(df_com_artstr_summary, df_com_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         community_type = if_else(is.na(community_type),"Total",community_type))

df_com_artstr_summary
```

```{r}
reduced_art_intake_by_community_plot <- ggplot(df_com_artstr_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12))+
  labs(
    title = " Reduced ART Intake",
    x = "Community Type",
    y = "Proportion of Individuals",
    fill =  "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

reduced_art_intake_by_community_plot

```

### Missed Scheduled Visits by Community

```{r}
df_com %>% group_by(community_type,hivbc) %>% 
  count()

df_com %>% group_by(community_type,hivac) %>% 
  count()
```

```{r}
df_com_hiv <- df_com %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_com_hiv_summary <- df_com_hiv %>%
  group_by(time,community_type) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_hiv_totals <- df_com_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_com_hiv_summary <- bind_rows(df_com_hiv_summary, df_com_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         community_type = if_else(is.na(community_type),"Total",community_type))



df_com_hiv_summary
```

```{r}
missed_scheduled_visit_by_community_type_plot <-  ggplot(df_com_hiv_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.15)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

missed_scheduled_visit_by_community_type_plot


```

### Run out of ART by Community

```{r}
df_com %>% group_by(community_type,artrunbc) %>% 
  count()

df_com %>% group_by(community_type,artrunac) %>% 
  count()
```

```{r}
df_com_artrun <- df_com %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_com_artrun_summary <- df_com_artrun %>%
  group_by(time,community_type) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_artrun_totals <- df_com_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_artrun_summary <- bind_rows(df_com_artrun_summary, df_com_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
 mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         community_type = if_else(is.na(community_type),"Total",community_type))




  
df_com_artrun_summary

```

```{r}
run_out_of_art_by_community_plot <- ggplot(df_com_artrun_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    title = "Run Out of ART",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
run_out_of_art_by_community_plot
```

```{r}
pc1 <- ggplot(df_com_artstr_summary, aes(x = community_type, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.25)) +
  labs(
    title = "Reduced ART Intake",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
pc1 ## 
```

```{r}
pc2 <- ggplot(df_com_hiv_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.25)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
pc2 ## Missed scheduled visits
```

```{r}
## Run out of pills
pc3 <- ggplot(df_com_artrun_summary, aes(x = community_type, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.25)) +
  labs(
    title =  "Run Out of ART",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title =  element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pc3

```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pc1 + pc2)/pc3
```

### Mobility

```{r}


df_mob <-  rakai %>% 
  select(mobility,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
  mutate(
    mobility = case_when(
           mobility %in% c(3,8,10) ~ "In-migrant",
           .default = "Long-term resident") %>% 
           fct_relevel("In-migrant") %>% 
           ff_label("Migration"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  )


```

### Run Out of ART by mobility

```{r}
df_mob %>% group_by(mobility,artrunbc) %>% 
  count()

df_mob %>% group_by(mobility,artrunac) %>% 
  count()
```

```{r}
df_mob_artrun <- df_mob %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_mob_artrun_summary <- df_mob_artrun %>%
  group_by(time,mobility) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_artrun_totals <- df_mob_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_artrun_summary <- bind_rows(df_mob_artrun_summary, df_mob_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
 mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         mobility = if_else(is.na(mobility),"Total",mobility))




  
df_mob_artrun_summary

```

```{r}
run_out_of_art_by_mobility_plot <- ggplot(df_mob_artrun_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    title = "Run Out of ART",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
run_out_of_art_by_mobility_plot
```

### reduced ART Intake by mobility

```{r}
df_mob %>% group_by(mobility,artstrbc) %>% 
  count()

df_mob %>% group_by(mobility,artstrac) %>% 
  count()
```

```{r}
df_mob_artstr <- df_mob %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_mob_artstr_summary <- df_mob_artstr %>%
  group_by(time,mobility) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_artstr_totals <- df_mob_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_mob_artstr_summary <- bind_rows(df_mob_artstr_summary, df_mob_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         mobility = if_else(is.na(mobility),"Total",mobility))

df_mob_artstr_summary
```

```{r}
reduced_art_intake_by_mobility_plot <- ggplot(df_mob_artstr_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20))+
  labs(
    title = " Reduced ART Intake",
    x = "Mobility",
    y = "Proportion of Individuals",
    fill =  "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

reduced_art_intake_by_mobility_plot

```

### Missed scheduled visits by mobility

```{r}
df_mob %>% group_by(mobility,hivbc) %>% 
  count()

df_mob %>% group_by(mobility,hivac) %>% 
  count()
```

```{r}
df_mob_hiv <- df_mob %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_mob_hiv_summary <- df_mob_hiv %>%
  group_by(time,mobility) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_hiv_totals <- df_mob_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_mob_hiv_summary <- bind_rows(df_mob_hiv_summary, df_mob_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         mobility = if_else(is.na(mobility),"Total",mobility))



df_com_hiv_summary
```

```{r}
missed_scheduled_visit_by_mobility_plot <-  ggplot(df_mob_hiv_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.2)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

missed_scheduled_visit_by_mobility_plot
```

```{r}
pm1 <- ggplot(df_mob_artstr_summary, aes(x = mobility, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.25)) +
  labs(
    title = "Reduced ART Intake",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
pm1 ##
```

```{r}
pm2 <- ggplot(df_mob_hiv_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.25)) +
  labs(
    caption = "Missed Scheduled Visits",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
pm2 ## Missed scheduled vis
```

```{r}
pm3 <- ggplot(df_mob_artrun_summary, aes(x = mobility, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.25)) +
  labs(
    title =  "Run Out of ART",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title =  element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pm3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pm1 + pm2)/pm3
```

### Age Categories

```{r}
df_age <-  rakai %>% 
  select(ageyrs,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
  mutate(
     age_cat = case_when(
                             ageyrs < 30 ~ "<30",
                             ageyrs >= 30 & ageyrs <= 39 ~  "30-39",
                             ageyrs >=40 & ageyrs <= 49 ~ "40-49") %>% 
           fct_relevel("<30") %>% 
           ff_label("Age group"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  ) %>% 
  select(-ageyrs)


```

```{r}
# df_age
```

### Run out of ART by Age Category

```{r}
df_age %>% group_by(age_cat,artrunbc) %>% 
  count()

df_age %>% group_by(age_cat,artrunac) %>% 
  count()
```

```{r}
df_age_artrun <- df_age %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_age_artrun_summary <- df_age_artrun %>%
  group_by(time, age_cat) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_artrun_totals <- df_age_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_artrun_summary <- bind_rows(df_age_artrun_summary, df_age_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    age_cat = if_else(is.na(age_cat), "Total", age_cat)
  )

df_age_artrun_summary

```

```{r}
run_out_of_art_by_age_plot <- ggplot(df_age_artrun_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.16)) +
  labs(
    title = "Run Out of ART",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
run_out_of_art_by_age_plot

```

### Missed Scheduled Visits by Age Category

```{r}
df_age %>% group_by(age_cat,hivbc) %>% 
  count()

df_age %>% group_by(age_cat,hivac) %>% 
  count()
```

```{r}
df_age_hiv <- df_age %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_age_hiv_summary <- df_age_hiv %>%
  group_by(time, age_cat) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_hiv_totals <- df_age_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_age_hiv_summary <- bind_rows(df_age_hiv_summary, df_age_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    age_cat = if_else(is.na(age_cat), "Total", age_cat)
  )

df_age_hiv_summary

```

```{r}

missed_scheduled_visit_by_age_plot <- ggplot(df_age_hiv_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.16)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

missed_scheduled_visit_by_age_plot

```

### Reduced ART Intake by Age Category

```{r}
df_age %>% group_by(age_cat,artstrbc) %>% 
  count()

df_age %>% group_by(age_cat,artstrac) %>% 
  count()
```

```{r}
df_age_artstr <- df_age %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_age_artstr_summary <- df_age_artstr %>%
  group_by(time, age_cat) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_artstr_totals <- df_age_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_age_artstr_summary <- bind_rows(df_age_artstr_summary, df_age_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    age_cat = if_else(is.na(age_cat), "Total", age_cat)
  )

df_age_artstr_summary

```

```{r}
reduced_art_intake_by_age_plot <- ggplot(df_age_artstr_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.16)) +
  labs(
    title = "Reduced ART Intake",
    x = "Age Category",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

reduced_art_intake_by_age_plot

```

```{r}

pa1 <- ggplot(df_age_artstr_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Reduced ART Intake",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )
pa1
```

```{r}
pa2 <- ggplot(df_age_hiv_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pa2
```

```{r}
pa3 <- ggplot(df_age_artrun_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
   title = "Run Out of ART",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pa3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pa1 + pa2)/pa3
```

# ART Duration

```{r}
df_dur <- rakai %>% 
  select(artyrs,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
 mutate(
  art_duration = case_when(
     artyrs >= 2 &  artyrs <= 5 ~ "2-5 years",
    artyrs > 5 ~ ">5 years",
    .default =  "<2 years"
  ) %>% 
    fct_relevel("<2 years","2-5 years") %>% 
    ff_label("Time on ART"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  ) %>% 
  select(-artyrs)



```

```{r}
# df_dur
```

```{r}
df_dur %>% group_by(art_duration,artstrbc) %>% 
  count()

df_dur %>% group_by(art_duration,artstrac) %>% 
  count()
```

### Reduced ART intake by ART duration

```{r}
df_dur_artstr <- df_dur %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_dur_artstr_summary <- df_dur_artstr %>%
  group_by(time, art_duration) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_artstr_totals <- df_dur_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_dur_artstr_summary <- bind_rows(df_dur_artstr_summary, df_dur_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    
    art_duration = if_else(is.na(art_duration), "Total", art_duration) %>% 
      fct_relevel("<2 years","2-5 years"),
    lower = if_else(lower < 0,0,lower)
  )

df_dur_artstr_summary


```

```{r}
reduced_art_intake_by_duration_plot <- ggplot(df_dur_artstr_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Reduced ART Intake",
    x = "ART Duration",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

reduced_art_intake_by_duration_plot

```

### Run out of ART by ART Duration

```{r}
df_dur %>% group_by(art_duration,artrunbc) %>% 
  count()

df_dur %>% group_by(art_duration,artrunac) %>% 
  count()
```

```{r}
df_dur_artrun <- df_dur %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_dur_artrun_summary <- df_dur_artrun %>%
  group_by(time, art_duration) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_artrun_totals <- df_dur_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_artrun_summary <- bind_rows(df_dur_artrun_summary, df_dur_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    art_duration = if_else(is.na(art_duration), "Total", art_duration)%>% 
      fct_relevel("<2 years","2-5 years"),
    lower = if_else(lower < 0,0,lower)
  )

df_dur_artrun_summary

```

```{r}
run_out_of_art_by_duration_plot <- ggplot(df_dur_artrun_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Run Out of ART",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

run_out_of_art_by_duration_plot

```

### Missed Scheduled visit by ART Duration

```{r}
df_dur %>% group_by(art_duration,hivbc) %>% 
  count()

df_dur %>% group_by(art_duration,hivac) %>% 
  count()
```

```{r}
df_dur_hiv <- df_dur %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_dur_hiv_summary <- df_dur_hiv %>%
  group_by(time, art_duration) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_hiv_totals <- df_dur_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_dur_hiv_summary <- bind_rows(df_dur_hiv_summary, df_dur_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    art_duration = if_else(is.na(art_duration), "Total", art_duration)%>% 
      fct_relevel("<2 years","2-5 years"),
    lower = if_else(lower < 0,0,lower)
  )

df_dur_hiv_summary

```

```{r}
missed_scheduled_visit_by_duration_plot <- ggplot(df_dur_hiv_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1),
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

missed_scheduled_visit_by_duration_plot

```

```{r}
pd1 <- ggplot(df_dur_artstr_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Reduced ART Intake",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pd1
```

```{r}
pd2 <- ggplot(df_dur_hiv_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pd2
```

```{r}
pd3 <- ggplot(df_dur_artrun_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Run Out of ART",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pd3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pd1 + pd2)/pd3
```

# Any disruption subplots

```{r}
df_disruption <-  rakai %>% 
   select(ageyrs,sex,mobility,arthoac,artrunac,artstrac,
    artyrs,comm_num,artrunbc,artstrbc,hivac,hivbc,copies,new_copies) %>% 
   mutate(
     age_cat = case_when(
       ageyrs < 30 ~ "<30",
       ageyrs >= 30 & ageyrs <= 39 ~  "30-39",
       ageyrs >=40 & ageyrs <= 49 ~ "40-49") %>% 
       fct_relevel("<30") %>% 
       ff_label("Age group"),
     
     sex = if_else(sex == "F","Female","Male") %>% 
       as_factor() %>%
       fct_relevel("Female") %>% 
       ff_label("Sex"),
     
     mobility = case_when(
       mobility %in% c(3,8,10) ~ "In-migrant",
       .default = "Long-term resident") %>% 
       fct_relevel("In-migrant") %>% 
       ff_label("Migration"),
     
     community_type = case_when(
       comm_num %in% c(38,770,771,774) ~ "Fishing community",
       .default = "Inland Community") %>% 
       fct_relevel("Inland Community") %>% 
       ff_label("Community type"),
     fishing_comm = if_else(community_type == "Fishing Community",1,0) %>% 
       ff_label("Lake Victoria Fishing Community"),
     
     art_duration = case_when(
       artyrs >= 2 &  artyrs <= 5 ~ "2-5 years",
       artyrs > 5 ~ ">5 years",
       .default =  "<2 years"
     ) %>% 
       fct_relevel("<2 years","2-5 years") %>% 
       ff_label("Time on ART"),
     
     hivac = if_else(hivac == 1, 1, 0) %>% 
       ff_label("Missed scheduled visit for HIV care"),
     
     hivbc = if_else(hivbc == 1, 1, 0) %>% 
       ff_label("Missed scheduled visit for HIV care"),
     
     artrunac = if_else(artrunac == 1, 1, 0) %>% 
       ff_label("Run out of ART before next refill"),
     
     artrunbc = if_else(artrunbc == 1, 1, 0) %>% 
       ff_label("Run out of ART before next refill"),
     
     artstrac = if_else(artstrac == 1, 1, 0) %>% 
       ff_label("Taken ART pills less frequently / in smaller amounts to conserve supply"),
     
     artstrbc = if_else(artstrbc == 1, 1, 0) %>% 
       ff_label("Taken ART pills less frequently / in smaller amounts to conserve supply"),
     
    )
```

```{r}

df_disruption <-  df_disruption %>% 
  select(sex,age_cat,community_type,art_duration,mobility,hivac,artrunac,artstrac,hivbc,artstrbc,artrunbc)
```

```{r}

df_disruption <-  df_disruption %>% 
mutate(any_disruption_b4 = if_else(rowSums(across(hivbc:artrunbc),na.rm = TRUE) > 0,1,0),
any_disruption_after = if_else(rowSums(across(hivac:artstrac),na.rm = TRUE) > 0,1,0))

```

```{r}
table(df_disruption$any_disruption_b4)
table(df_disruption$any_disruption_after)
```

```{r}

prepare_data <- function(data, group_var) {
  grouped_data <- data %>%
    group_by({{ group_var }}) %>%
    summarise(
      n_b4 = sum(any_disruption_b4, na.rm = TRUE),
      total_b4 = n(),
      n_after = sum(any_disruption_after, na.rm = TRUE),
      total_after = n(),
      .groups = "drop"
    ) %>%
    mutate(
      proportion_b4 = n_b4 / total_b4,
      proportion_after = n_after / total_after,
      se_b4 = sqrt(proportion_b4 * (1 - proportion_b4) / total_b4),
      se_after = sqrt(proportion_after * (1 - proportion_after) / total_after),
      lower_b4 = proportion_b4 - 1.96 * se_b4,
      upper_b4 = proportion_b4 + 1.96 * se_b4,
      lower_after = proportion_after - 1.96 * se_after,
      upper_after = proportion_after + 1.96 * se_after
    ) %>%
    pivot_longer(
      cols = starts_with("proportion"),
      names_to = "time",
      values_to = "proportion"
    ) %>%
    mutate(
      time = if_else(time == "proportion_b4", "Before Covid-19", "After Covid-19"),
      lower = if_else(time == "Before Covid-19", lower_b4, lower_after),
      upper = if_else(time == "Before Covid-19", upper_b4, upper_after)
    ) %>%
    select({{ group_var }}, time, proportion, lower, upper)
  

  total_data <- data %>%
    summarise(
      n_b4 = sum(any_disruption_b4, na.rm = TRUE),
      total_b4 = n(),
      n_after = sum(any_disruption_after, na.rm = TRUE),
      total_after = n(),
      .groups = "drop"
    ) %>%
    mutate(
      proportion_b4 = n_b4 / total_b4,
      proportion_after = n_after / total_after,
      se_b4 = sqrt(proportion_b4 * (1 - proportion_b4) / total_b4),
      se_after = sqrt(proportion_after * (1 - proportion_after) / total_after),
      lower_b4 = proportion_b4 - 1.96 * se_b4,
      upper_b4 = proportion_b4 + 1.96 * se_b4,
      lower_after = proportion_after - 1.96 * se_after,
      upper_after = proportion_after + 1.96 * se_after
    ) %>%
    pivot_longer(
      cols = starts_with("proportion"),
      names_to = "time",
      values_to = "proportion"
    ) %>%
    mutate(
      time = if_else(time == "proportion_b4", "Before Covid-19", "After Covid-19"),
      lower = if_else(time == "Before Covid-19", lower_b4, lower_after),
      upper = if_else(time == "Before Covid-19", upper_b4, upper_after),
      {{ group_var }} := "Total" # Add "Total" to the group variable
    ) %>%
    select({{ group_var }}, time, proportion, lower, upper)

  bind_rows(grouped_data, total_data)
}


```

```{r}

summary_by_sex <- prepare_data(df_disruption, sex)
summary_by_age <- prepare_data(df_disruption, age_cat)
summary_by_mobility <- prepare_data(df_disruption, mobility)
summary_by_community <- prepare_data(df_disruption, community_type)
summary_by_art_duration <- prepare_data(df_disruption,art_duration)

```

```{r}
summary_by_age <-  summary_by_age %>% 
  mutate(age_cat = as_factor(age_cat) %>% 
           fct_relevel("<30","30-39","40-49"),
         time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"))
```

```{r}
summary_by_community <-  summary_by_community %>% 
  mutate(
   time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
   community_type = as_factor(community_type) %>% 
     fct_relevel("Fishing community")
  )
```

```{r}
summary_by_mobility <-  summary_by_mobility %>% 
  mutate(
    time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
    mobility = as_factor(mobility) %>% 
      fct_relevel("In-migrant","Long-term resident")
  )
```

```{r}
summary_by_sex <-  summary_by_sex %>% 
  mutate(
    time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
    sex = as_factor(sex) %>% 
      fct_relevel("Female","Male")
  )
```

```{r}
summary_by_art_duration <-  summary_by_art_duration %>% 
  mutate(
    time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
    art_duration = as_factor(art_duration) %>% 
      fct_relevel("<2 years","2-5 years", ">5 years","Total")
  )
```

### Any Disruption by Sex

```{r}

pr1 <- summary_by_sex %>% 
ggplot(aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Any Disruption",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pr1
```

### Any disruption by community type

```{r}
pr2 <- summary_by_community %>% 
ggplot(aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Any Disruption",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pr2
```

### Any disruption by age category

```{r}
pr3 <- summary_by_age %>% 
ggplot(aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Any Disruption",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pr3
```

### Any Disruption By Mobility

```{r}
pr4 <- summary_by_mobility %>% 
ggplot(aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.26)) +
  labs(
    title = "Any Disruption",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pr4
```

### Any Disruption by ART duration

```{r}

pr5 <- summary_by_art_duration %>% 
ggplot(aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.25)) +
  labs(
    title = "Any Disruption",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pr5
```

### Combined Plots

#### Age category

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pa1 + pa2)/(pa3 + pr3)
```

### Community type

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pc1 + pc2)/(pc2 + pr2)
```

### Mobility

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pm1 + pm2)/(pm3 +pr4)
```

### ART Duration

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pd1 + pd2)/(pd3 + pr5)
```

### Sex

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(ps1 + ps2)/(ps3 + pr1)
```

### VIRAEMIA PREVALENCE

```{r}
df_rakai_reg <- rakai %>% 
  select(ageyrs,sex,mobility,arthoac,artrunac,artstrac,
         artyrs,comm_num,artrunbc,artstrbc,hivac,hivbc,copies,new_copies) %>% 
  filter(copies != "INV.IC ",!is.na(copies),!is.na(new_copies)) %>% 
  
  mutate(
    copies = str_remove_all(copies, "<\\s*"),
    copies = if_else(copies == "BD", "0", copies),
    copies = as.numeric(copies),
    
    new_copies = str_remove_all(new_copies, "<\\s*"),
    new_copies = if_else(new_copies == "BD", "0", new_copies),
    new_copies = as.numeric(new_copies)
  ) %>% 
  mutate(viral_load_b4 = if_else(copies < 200, "Viral Load Sppression","Viraemia") %>% 
           ff_label("HIV RNA viral load, in copies/ml"),
         viral_load_after = if_else(new_copies < 200,"Viral Load Sppression","Viraemia") %>% 
           ff_label("HIV RNA viral load, in copies/ml")) %>% 
  mutate(
    suppbc = if_else(viral_load_b4 == "Viral Load Suppression", 1, 0),
    suppac = if_else(viral_load_after == "Viral Load Suppression", 1, 0)
  ) %>% 
 mutate(
    
    age_cat = case_when(
      ageyrs < 30 ~ "<30",
      ageyrs >= 30 & ageyrs <= 39 ~  "30-39",
      ageyrs >=40 & ageyrs <= 49 ~ "40-49") %>% 
      fct_relevel("40-49") %>% 
      ff_label("Age group"),
    
    sex = if_else(sex == "F","Female","Male") %>% 
      as_factor() %>%
      fct_relevel("Female") %>% 
      ff_label("Sex"),
    
    mobility = case_when(
      mobility %in% c(3,8,10) ~ "In-migrant",
      .default = "Long-term resident") %>% 
      fct_relevel("In-migrant") %>% 
      ff_label("Migration"),
    
    community_type = case_when(
      comm_num %in% c(38,770,771,774) ~ "Fishing community",
      .default = "Inland Community") %>% 
      fct_relevel("Inland Community") %>% 
      ff_label("Community type"),
    fishing_comm = if_else(community_type == "Fishing Community",1,0) %>% 
      ff_label("Lake Victoria Fishing Community"),
    
    art_duration = case_when(
      artyrs >= 2 &  artyrs <= 5 ~ "2-5 years",
      artyrs > 5 ~ ">5 years",
      .default =  "<2 years"
    ) %>% 
      fct_relevel("<2 years","2-5 years") %>% 
      ff_label("Time on ART"),
    
    hivac = if_else(hivac == 1, 1, 0) %>% 
      ff_label("Missed scheduled Visit"),
    
    hivbc = if_else(hivbc == 1, 1, 0) %>% 
      ff_label("Missed Scheduled Visit"),
    
    artrunac = if_else(artrunac == 1, 1, 0) %>% 
      ff_label("Run out of ARTl"),
    
    artrunbc = if_else(artrunbc == 1, 1, 0) %>% 
      ff_label("Run out of ART"),
    
    artstrac = if_else(artstrac == 1, 1, 0) %>% 
      ff_label("Reduced ART Intake"),
    
    artstrbc = if_else(artstrbc == 1, 1, 0) %>% 
      ff_label("Reduced ART Intake"),
    
  ) 



df_rakai_reg2 <- df_rakai_reg %>% 
  mutate(age_cat = age_cat %>% 
           fct_relevel("<30"))

```

```{r}
df_viraemia <-   df_rakai_reg %>% 
    select(sex,age_cat,mobility,community_type,art_duration,
           hivbc,artrunbc,artstrbc,hivac,artrunac,artstrac,viral_load_b4,
           viral_load_after,suppbc,suppac) %>% 
   mutate(any_disruption_b4 = if_else(rowSums(across(hivbc:artrunbc),na.rm = TRUE) > 0,1,0) %>% 
            ff_label("Any ART Disruption"),
  any_disruption_after = if_else(rowSums(across(hivac:artstrac),na.rm = TRUE) > 0,1,0)%>% 
  ff_label("Any ART Disruption")) 
```

```{r}
df_viraemia <-  df_viraemia %>% 
  mutate(
    viraemia_after_covid = if_else(viral_load_after == "Viraemia","Yes","No") %>% 
      fct_relevel("No") %>% 
      ff_label("Viraemia"),
    viraemia_after_dum = if_else(viral_load_after == "Viraemia",1,0) %>% 
      ff_label("Viraemia"),
    
    viraemia_b4_covid = if_else(viral_load_b4 == "Viraemia","Yes","No") %>% 
      fct_relevel("No") %>% 
      ff_label("Viraemia"),
    viraemia_b4_dum = if_else(viral_load_b4 == "Viraemia",1,0) %>% 
      ff_label("Viraemia"),
     art_disruption_b4 = if_else(any_disruption_b4 == 1,"Yes","No") %>% 
      fct_relevel("No") %>% 
      ff_label("Any ART Disruption pre-covid"),
    
    art_disruption_after = if_else(any_disruption_after == 1,"Yes","No") %>% 
      fct_relevel("No") %>% 
      ff_label("Any ART Disruption post-covid")
  )

 # saveRDS(df_viraemia, file = "df_viraemia.rds")
```

```{r}
prr_table_full <- df_viraemia %>% 
  select(art_disruption_b4,sex,age_cat,mobility,community_type,
         art_duration,viraemia_after_covid,art_disruption_after) %>% 
  mutate(age_cat = age_cat %>% 
           fct_relevel("<30"))
  
tbl_summary_obj <- prr_table_full %>% 
  tbl_summary(
  by = viraemia_after_covid,
  percent = "row",
  include = c(art_disruption_after, art_disruption_b4, sex, age_cat, mobility, community_type,
              art_duration, viraemia_after_covid)
)

tbl_full <- tbl_summary_obj %>%
  modify_spanning_header(
    all_stat_cols() ~ "**Viraemia After COVID**"
  )

tbl_full

```

```{r}
tbl_ureg <- df_viraemia %>% 
  select(art_disruption_after,sex,age_cat,mobility,community_type,
         art_duration,viraemia_after_dum,art_disruption_b4) %>% 
tbl_uvregression(
  method = glm.nb,
  y = viraemia_after_dum,
 # x = everything(),
  method.args = list(), 
  exponentiate = TRUE
)

tbl_ureg <- tbl_ureg %>%
  modify_column_hide(columns = c("N", "p.value","N_obs"))

tbl_ureg



tbl_combined <- tbl_merge(
  tbls = list(tbl_full, tbl_ureg), # Tables to combine
  tab_spanner = c("**Viraemia After COVID**", "**Prevalence Risk Ratios**") # Headers for each table
) 
# Display the combined table
tbl_combined

```

|  |  |  |  |  |
|----|----|----|----|----|
|  | **Viraemia Post Covid-19 (n, %)** |  |  |  |
| **Characteristic** | **No (N = 2,650)** | **Yes (N = 135)** | **PRR** | **95% CI** |
| Any ART Disruption post-covid | 347 (93%) | 28 (7.5%) | 1.68 | (1.09, 2.51) |
| Any ART Disruption pre-covid | 115 (91%) | 11 (8.7%) | 1.87 | (0.95, 3.31) |
| **Sex** |  |  |  |  |
| Female | 1,714 (96%) | 66 (3.7%) | \_\_ | \_\_ |
| Male | 936 (93%) | 69 (6.9%) | 1.85 | (1.32, 2.60) |
| **Age group** |  |  |  |  |
| \<30 | 390 (90%) | 44 (10%) | \_\_ | \_\_ |
| 30-39 | 1,136 (94%) | 67 (5.6%) | 0.55 | (0.38, 0.81) |
| 40-49 | 1,124 (98%) | 24 (2.1%) | 0.21 | (0.12, 0.34) |
| **Migration** |  |  |  |  |
| In-migrant | 596 (95%) | 34 (5.4%) | \_\_ | \_\_ |
| Long-term resident | 2,054 (95%) | 101 (4.7%) | 0.87 | (0.60, 1.30) |
| **Community type** |  |  |  |  |
| Inland Community | 1,212 (96%) | 48 (3.8%) | \_\_ | \_\_ |
| Fishing community | 87 (5.7%) | 1438 (94.3%) | 1.50 | (1.06, 2.15) |

### MULTIVARIABLE REGRESSION

```{r}
model_nb1 <-df_viraemia %>% 
  glm.nb(viraemia_after_dum ~ any_disruption_after + any_disruption_b4 + sex + 
           age_cat+ mobility+community_type + art_duration, data = .)

model_nb1 %>% tidy(exponentiate = TRUE,conf.int = TRUE)
```

```{r}
df_forest <- model_nb1 %>% tidy(exponentiate = TRUE,conf.int = TRUE)%>% 
  filter(term != "(Intercept)") %>% 
  mutate(term = case_when(
    term == "any_disruption_after" ~ "ART Disruption After (Yes)",
    term == "any_disruption_b4" ~ "ART Disruption Before (Yes)",
    term == "sexMale" ~ "Sex (Male vs Female)",
    term == "age_cat30-39" ~ "Age: 30-39 vs <30",
    term == "age_cat40-49" ~ "Age: 40-49 vs <30",
    term == "mobilityLong-term resident" ~ "Mobility (Long-term Resident)",
    term == "community_typeFishing community" ~ "Community Type (Fishing)",
    term == "art_duration2-5 years" ~ "ART Duration: 2-5 years",
    term == "art_duration>5 years" ~ "ART Duration: >5 years",
    TRUE ~ term 
  )) %>% 
  arrange(desc(estimate))

### saveRDS(df_forest, file = "df_forest_plot.rds")
```

```{r}
ggplot(df_forest, aes(y = reorder(term, estimate), x = estimate)) +
  geom_point(size = 3, color = "blue") + 
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2, color = "black") +  
  geom_vline(xintercept = 1, linetype = "dashed", color = "red") +  
  theme_minimal() +
  labs(
    title = "Forest Plot of Regression Results",
    x = "Prevalence Ratio (95% CI)",
    y = "Variables"
  ) +
  theme(
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.major.y = element_blank()  
  )
```

### model stratified by sex

```{r}
model_nb_sex <- df_viraemia %>%
  group_by(sex) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ glm.nb(viraemia_after_dum ~ any_disruption_after + any_disruption_b4 + age_cat + mobility + community_type + art_duration, 
                               data = .x)),
    results = map(model, tidy) ,
    ci = map(model, ~ confint(.x) %>% as_tibble()),
    ci = map(ci, ~ .x %>%
                    rename(ci.lower = `2.5 %`, ci.upper = `97.5 %`))
  )
```

```{r}

model_nb_sex2 <- df_viraemia %>%
  group_by(sex) %>%
  nest() %>%
  mutate(
    model = map(data, ~ glm.nb(viraemia_after_dum ~ any_disruption_after + any_disruption_b4 + age_cat + mobility + community_type + art_duration, 
                               data = .x)),
    results = map(model, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE)) 
  )

model_nb_sex2 <-  model_nb_sex2 %>% unnest(cols = results) %>% 
  select(sex,term,estimate,conf.low,conf.high)
```

```{r}
model_nb_sex2 %>% filter(sex == "Male")
model_nb_sex2 %>% filter(sex == "Female")

# model_nb_sex %>% pluck("model", 1) %>% tidy(exponentiate = TRUE)

```

```{r}
# model_nb_sex %>% select(sex, results,ci)
```

```{r}
# model_nb_sex %>% unnest(c(results,ci))

```

```{r}
model_nb_sex %>% select(sex, results) %>% unnest(results)
model_nb_sex %>% select(sex,ci) %>% unnest(ci)

```

```{r}
model_nb_sex %>% select(sex, results,ci) %>% unnest(c(results,ci))  
  
```

```{r}
nb_model_male <- model_nb_sex %>% select(sex, results,ci) %>% unnest(c(results,ci)) %>% 
  filter(sex == "Male")


nb_model_female <- model_nb_sex %>% select(sex, results,ci) %>% unnest(c(results,ci)) %>% 
  filter(sex == "Female")
```

```{r}
nb_model_female
nb_model_male
```

```{r}
nb_model_female %>% 
  select(term,estimate,ci.lower,ci.upper)
```

```{r}
nb_model_male %>% 
  select(term,estimate,ci.lower,ci.upper)
```

```{r}

```
