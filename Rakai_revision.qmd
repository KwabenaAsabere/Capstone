---
title: "TABLE ONE"
df-print: kable
code-overflow: wrap
execute:
  echo: true
  warning: false
  message: false
format: 
  html:
    embed-resources: true
    fig-width: 8
    fig-height: 6
    dpi: 300
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(finalfit)
library(gtsummary)
library(patchwork)
```

```{r}
rakai = read_csv("rakai_updated.csv")
dim(rakai)
#glimpse(rakai)
#missing_glimpse(rakai)

```

```{r}
df1 <- rakai %>% 
  select(ageyrs,sex,locate,occup1,currmarr,evermarr,mobility,
          artdays,artwks,artmos,artyrs,comm_num,educyrs,religion)
```

```{r}
df2 <- rakai %>% 
  select(ageyrs,sex,locate,occup1,currmarr,evermarr,mobility,
  artdays,artwks,artmos,artyrs,comm_num,artrunbc,artstrbc,hivac,copies,new_copies)

```

```{r}



```

```{r}
df3 <- df1 %>% 
  mutate(ageyrs = ageyrs %>%  ff_label("Age (years)"),
         sex = if_else(sex == "F","Female","Male") %>% 
           as_factor() %>%
           fct_relevel("Female") %>% 
           ff_label("Sex"),
         mobility = case_when(
           mobility %in% c(3,8,10) ~ "In-migrant",
           .default = "Long-term resident") %>% 
           fct_relevel("In-migrant") %>% 
           ff_label("Migration"),
         community_type = case_when(
           comm_num %in% c(38,770,771,774) ~ "Fishing community",
                                     .default = "Inland Community") %>% 
           fct_relevel("Inland Community") %>% 
           ff_label("Community type"),
         fishing_comm = if_else(community_type == "Fishing Community",1,0) %>% 
           ff_label("Lake Victoria Fishing Community"),
         
         primary_occupation = case_when(
           occup1 %in% c(1,2,5) ~ "Agriculture/Homebrewing",
           occup1 %in% c(10,11) ~ "Trading or shopkeeping",
           occup1 %in% c(12,18) ~ "Bar work or waitressing",
           occup1 %in% c(2,3,4) ~ "House work",
           occup1  == 7 ~ "Fishing-related occupation",
           .default = "Other") %>% 
           fct_relevel("Agriculture/Homebrewing","Trading or shopkeeping") %>% 
           ff_label("Primary Occupation"),
         
         age_cat = case_when(
                             ageyrs < 30 ~ "<30",
                             ageyrs >= 30 & ageyrs <= 39 ~  "30-39",
                             ageyrs >=40 & ageyrs <= 49 ~ "40-49") %>% 
           fct_relevel("<30") %>% 
           ff_label("Age group"),
         
         current_marital_status = case_when(
           currmarr == 1 ~ "Currently married",
           currmarr == 2 ~ "Previously married",
           currmarr == 8 ~ "Never married"
           ) %>% 
           fct_relevel("Never married","Currently married") %>% 
           ff_label("Current marital status"),
         
         art_duration = case_when(
           artyrs >= 1 & artyrs < 2 ~ "1-2 years",
           artyrs > 2 &  artyrs <= 5 ~ "2-5 years",
           artyrs > 5 ~ ">5 years",
           .default =  "<1 year"
         ) %>% 
           fct_relevel("<1 year","1-2 years","2-5 years") %>% 
           ff_label("Time on ART"),
         
         education_level = case_when(
           educyrs == 8 ~ "No formal education",
           educyrs %in% c(1,2) ~ "Primary",
           educyrs %in% c(3,4) ~ "Secondary",
           educyrs %in% c(5,6,7,10,11) ~ "Technical/University"
          
          ) %>% 
           fct_relevel("No formal education") %>% 
           ff_label("Educational attainment"),
         
         religion = case_when(
           religion %in% c(1,6) ~ "Other or none",
           religion %in% c(2,3,4) ~ "Catholic/Christian",
           religion == 5 ~ "Muslim"
         ) %>% 
           ff_label("Religion")
                                    
         
  )

```

```{r}
df4 <- df3 %>% 
  select(
    ageyrs,age_cat,sex,current_marital_status,education_level,primary_occupation,
    mobility,community_type,art_duration
  )
```

### **Table One**

```{r}
df4 %>%
  tbl_summary(
    by = sex,
    statistic = list(
      all_categorical() ~ "{n} ({p}%)",
      all_continuous()  ~ "{median} ({IQR})"
    ),
    digits = list(
      all_categorical() ~ 0,
      all_continuous()  ~ 0
    )
  ) %>%
  add_overall() %>%
   bold_labels() %>%
  italicize_levels() %>%
  modify_spanning_header(
    update = all_stat_cols() ~ "**Sex**"
  ) 
```

```{r}
df5 <- rakai %>% 
  select(sex,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8)
```

```{r}
df6 <- df5 %>% 
  mutate(
    sex = if_else(sex == "F","Female","Male") %>% 
      as_factor() %>%
      fct_relevel("Female") %>% 
      as_factor() %>% 
      ff_label("Sex"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  )
```

### **Viral Load Suppression**

```{r}
df7 <- df6 %>% filter(copies != "INV.IC ",!is.na(copies),!is.na(new_copies)) %>% 
  mutate(
    copies = str_remove_all(copies, "<\\s*"),
    copies = if_else(copies == "BD", "0", copies),
    copies = as.numeric(copies),
    
    new_copies = str_remove_all(new_copies, "<\\s*"),
    new_copies = if_else(new_copies == "BD", "0", new_copies),
    new_copies = as.numeric(new_copies)
  ) %>% 
  mutate(viral_load_b4 = if_else(copies < 200, "Viral Load Sppression","Viraemia") %>% 
           ff_label("HIV RNA viral load, in copies/ml"),
         viral_load_after = if_else(new_copies < 200,"Viral Load Sppression","Viraemia") %>% 
           ff_label("HIV RNA viral load, in copies/ml"))
```

```{r}
df_vl_supp  <- df7 %>%
  mutate(
    suppbc = if_else(viral_load_b4 == "Viral Load Suppression", 1, 0),
    suppac = if_else(viral_load_after == "Viral Load Suppression", 1, 0)
  ) %>% 
  select(-c(copies,new_copies))%>% 
  pivot_longer(
    cols = c(viral_load_b4,viral_load_after),
    names_to = "variable",
    values_to = "viral_load"
  ) %>%
  mutate(
    time = if_else(grepl("b4$", variable), "Before Covid-19", "After Covid-19"),
  )
  
  
df_vl_summary <- df_vl_supp %>% filter(!is.na(viral_load)) %>% 
  group_by(time,viral_load) %>%
  summarise(
    n_suppressed = n(),
    .groups = "drop"
  ) %>% 
  mutate(time = as_factor(time) %>%  fct_relevel("Before Covid-19"),
         viral_load = as_factor(viral_load) %>% 
           fct_relevel("Viral Load Suppression"))

df_vl_summary <-  df_vl_summary %>% 
  group_by(time) %>% 
  summarise(n = sum(n_suppressed)) %>% 
  left_join(df_vl_summary,join_by(time))

df_vl_summary <- df_vl_summary  %>%
  mutate(
    proportion = n_suppressed / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) 
df_vl_summary
```

```{r}
ggplot(df_vl_summary, aes(x = viral_load, y = proportion, fill = time)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = 0.7),
    width = 0.5
  ) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 0.5
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Viral Load", y = "Proportion of individuals", fill = "Time") +
  
  theme_minimal()+
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

```

### **Proportion taking ART pills less frequently / in smaller amounts**

```{r}
df6 %>% group_by(sex,artstrbc) %>% 
  count()

df6 %>% group_by(sex,artstrac) %>% 
  count()
```

```{r}
df_artstr <- df6 %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_artstr_summary <- df_artstr %>%
  group_by(time,sex) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_artstr_totals <- df_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_artstr_summary <- bind_rows(df_artstr_summary, df_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         sex= if_else(is.na(sex),"Total",sex))



df_artstr_summary



```

```{r}
reduced_art_intake_plot <- ggplot(df_artstr_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12))+
  labs(
    title = " Reduced ART Intake",
    x = "Sex",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

reduced_art_intake_plot

```

### **Run out of ART before next refill**

```{r}
df6 %>% group_by(sex,artrunbc) %>% 
  count()

df6 %>% group_by(sex,artrunac) %>% 
  count()

```

```{r}

df_artrun <- df6 %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before", "After"),
    variable = "Run out of ART before next refill"
  )


df_artrun_summary <- df_artrun %>%
  group_by(time,sex) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_artrun_totals <- df_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )
 

df_artrun_totals

df_artrun_summary <- bind_rows(df_artrun_summary, df_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
        sex= if_else(is.na(sex),"Total",sex))


df_artrun_summary
```

```{r}
run_out_of_art_plot <- ggplot(df_artrun_summary, aes(x = sex, y = proportion,fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    title = "Run Out of ART",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
run_out_of_art_plot


```

### **Missed Scheduled Visits**

```{r}
df6 %>% group_by(sex,hivbc) %>% 
  count()

df6 %>% group_by(sex,hivac) %>% 
  count()
```

```{r}
df_hiv <- df6 %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before", "After"),
    variable = "Missed Scheduled Visits"
  )

df_hiv_summary <- df_hiv %>%
  group_by(time,sex) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_hiv_totals <- df_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_hiv_summary <- bind_rows(df_hiv_summary, df_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         sex= if_else(is.na(sex),"Total",sex))



df_hiv_summary
```

```{r}
missed_scheduled_visit_plot <-  ggplot(df_hiv_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

missed_scheduled_visit_plot

```

### Combined Plots

```{r}
a <- missed_scheduled_visit_plot
b <- reduced_art_intake_plot
c <- run_out_of_art_plot


```

```{r}
ps1 <- ggplot(df_hiv_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    caption = "Missed Scheduled Visits",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
ps1 ## Missed scheduled visits
```

```{r}
### Reduced pill intake
ps2 <- ggplot(df_artstr_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12))+
  labs(
    caption = " Reduced ART Intake",
    x = "Sex",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
ps2

```

```{r}
## Run out of pills
ps3 <- ggplot(df_artrun_summary, aes(x = sex, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    caption =  "Run Out of ART",
    x = "Sex",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption =  element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

ps3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(ps1 + ps2)/ps3
```

# SUBPLOTS

### Community Type

```{r}
df_com <-  rakai %>% 
  select(comm_num,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
  mutate(
    community_type = case_when(
      comm_num %in% c(38,770,771,774) ~ "Fishing community",
      .default = "Inland Community") %>% 
      fct_relevel("Inland Community") %>% 
      ff_label("Community type"),

    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  ) %>% 
  select(-comm_num)

```

```{r}
# df_com
```

### Reduced ART intake by Community

```{r}
df_com %>% group_by(community_type,artstrbc) %>% 
  count()

df_com %>% group_by(community_type,artstrac) %>% 
  count()
```

```{r}
df_com_artstr <- df_com %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_com_artstr_summary <- df_com_artstr %>%
  group_by(time,community_type) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_artstr_totals <- df_com_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_com_artstr_summary <- bind_rows(df_com_artstr_summary, df_com_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         community_type = if_else(is.na(community_type),"Total",community_type))

df_com_artstr_summary
```

```{r}
reduced_art_intake_by_community_plot <- ggplot(df_com_artstr_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12))+
  labs(
    title = " Reduced ART Intake",
    x = "Community Type",
    y = "Proportion of Individuals",
    fill =  "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

reduced_art_intake_by_community_plot

```

### Missed Scheduled Visits by Community

```{r}
df_com %>% group_by(community_type,hivbc) %>% 
  count()

df_com %>% group_by(community_type,hivac) %>% 
  count()
```

```{r}
df_com_hiv <- df_com %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_com_hiv_summary <- df_com_hiv %>%
  group_by(time,community_type) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_hiv_totals <- df_com_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_com_hiv_summary <- bind_rows(df_com_hiv_summary, df_com_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         community_type = if_else(is.na(community_type),"Total",community_type))



df_com_hiv_summary
```

```{r}
missed_scheduled_visit_by_community_type_plot <-  ggplot(df_com_hiv_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.15)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

missed_scheduled_visit_by_community_type_plot


```

### Run out of ART by Community

```{r}
df_com %>% group_by(community_type,artrunbc) %>% 
  count()

df_com %>% group_by(community_type,artrunac) %>% 
  count()
```

```{r}
df_com_artrun <- df_com %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_com_artrun_summary <- df_com_artrun %>%
  group_by(time,community_type) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_artrun_totals <- df_com_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_com_artrun_summary <- bind_rows(df_com_artrun_summary, df_com_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
 mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         community_type = if_else(is.na(community_type),"Total",community_type))




  
df_com_artrun_summary

```

```{r}
run_out_of_art_by_community_plot <- ggplot(df_com_artrun_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    title = "Run Out of ART",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
run_out_of_art_by_community_plot
```

```{r}
pc1 <- ggplot(df_com_artstr_summary, aes(x = community_type, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.15)) +
  labs(
    caption = "Reduced ART Intake",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
pc1 ## 
```

```{r}
pc2 <- ggplot(df_com_hiv_summary, aes(x = community_type, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.15)) +
  labs(
    caption = "Missed Scheduled Visits",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
pc2 ## Missed scheduled visits
```

```{r}
## Run out of pills
pc3 <- ggplot(df_com_artrun_summary, aes(x = community_type, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    caption =  "Run Out of ART",
    x = "Community Type",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption =  element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

pc3

```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pc1 + pc2)/pc3
```

### Mobility

```{r}


df_mob <-  rakai %>% 
  select(mobility,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
  mutate(
    mobility = case_when(
           mobility %in% c(3,8,10) ~ "In-migrant",
           .default = "Long-term resident") %>% 
           fct_relevel("In-migrant") %>% 
           ff_label("Migration"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  )
```

### Run Out of ART by mobility

```{r}
df_mob %>% group_by(mobility,artrunbc) %>% 
  count()

df_mob %>% group_by(mobility,artrunac) %>% 
  count()
```

```{r}
df_mob_artrun <- df_mob %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_mob_artrun_summary <- df_mob_artrun %>%
  group_by(time,mobility) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_artrun_totals <- df_mob_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_artrun_summary <- bind_rows(df_mob_artrun_summary, df_mob_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
 mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         mobility = if_else(is.na(mobility),"Total",mobility))




  
df_mob_artrun_summary

```

```{r}
run_out_of_art_by_mobility_plot <- ggplot(df_mob_artrun_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.12)) +
  labs(
    title = "Run Out of ART",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
run_out_of_art_by_mobility_plot
```

### reduced ART Intake by mobility

```{r}
df_mob %>% group_by(mobility,artstrbc) %>% 
  count()

df_mob %>% group_by(mobility,artstrac) %>% 
  count()
```

```{r}
df_mob_artstr <- df_mob %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_mob_artstr_summary <- df_mob_artstr %>%
  group_by(time,mobility) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_artstr_totals <- df_mob_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_mob_artstr_summary <- bind_rows(df_mob_artstr_summary, df_mob_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         mobility = if_else(is.na(mobility),"Total",mobility))

df_mob_artstr_summary
```

```{r}
reduced_art_intake_by_mobility_plot <- ggplot(df_mob_artstr_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20))+
  labs(
    title = " Reduced ART Intake",
    x = "Mobility",
    y = "Proportion of Individuals",
    fill =  "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

reduced_art_intake_by_mobility_plot

```

### Missed scheduled visits by mobility

```{r}
df_mob %>% group_by(mobility,hivbc) %>% 
  count()

df_mob %>% group_by(mobility,hivac) %>% 
  count()
```

```{r}
df_mob_hiv <- df_mob %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_mob_hiv_summary <- df_mob_hiv %>%
  group_by(time,mobility) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_mob_hiv_totals <- df_mob_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_mob_hiv_summary <- bind_rows(df_mob_hiv_summary, df_mob_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  )%>% 
  mutate(time = as_factor(time) %>% 
           fct_relevel("Before Covid-19"),
         mobility = if_else(is.na(mobility),"Total",mobility))



df_com_hiv_summary
```

```{r}
missed_scheduled_visit_by_mobility_plot <-  ggplot(df_mob_hiv_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.2)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

missed_scheduled_visit_by_mobility_plot
```

```{r}
pm1 <- ggplot(df_mob_artstr_summary, aes(x = mobility, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20)) +
  labs(
    caption = "Reduced ART Intake",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
pm1 ##
```

```{r}
pm2 <- ggplot(df_mob_hiv_summary, aes(x = mobility, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20)) +
  labs(
    caption = "Missed Scheduled Visits",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
pm2 ## Missed scheduled vis
```

```{r}
pm3 <- ggplot(df_mob_artrun_summary, aes(x = mobility, y = proportion, fill =time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),limits = c(0, 0.20)) +
  labs(
    caption =  "Run Out of ART",
    x = "Mobility",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption =  element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

pm3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pm1 + pm2)/pm3
```

### Age Categories

```{r}
df_age <-  rakai %>% 
  select(ageyrs,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
  mutate(
     age_cat = case_when(
                             ageyrs < 30 ~ "<30",
                             ageyrs >= 30 & ageyrs <= 39 ~  "30-39",
                             ageyrs >=40 & ageyrs <= 49 ~ "40-49") %>% 
           fct_relevel("<30") %>% 
           ff_label("Age group"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  ) %>% 
  select(-ageyrs)
```

```{r}
# df_age
```

### Run out of ART by Age Category

```{r}
df_age %>% group_by(age_cat,artrunbc) %>% 
  count()

df_age %>% group_by(age_cat,artrunac) %>% 
  count()
```

```{r}
df_age_artrun <- df_age %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_age_artrun_summary <- df_age_artrun %>%
  group_by(time, age_cat) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_artrun_totals <- df_age_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_artrun_summary <- bind_rows(df_age_artrun_summary, df_age_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    age_cat = if_else(is.na(age_cat), "Total", age_cat)
  )

df_age_artrun_summary

```

```{r}
run_out_of_art_by_age_plot <- ggplot(df_age_artrun_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.15)) +
  labs(
    title = "Run Out of ART",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
run_out_of_art_by_age_plot

```

### Missed Scheduled Visits by Age Category

```{r}
df_age %>% group_by(age_cat,hivbc) %>% 
  count()

df_age %>% group_by(age_cat,hivac) %>% 
  count()
```

```{r}
df_age_hiv <- df_age %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_age_hiv_summary <- df_age_hiv %>%
  group_by(time, age_cat) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_hiv_totals <- df_age_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_age_hiv_summary <- bind_rows(df_age_hiv_summary, df_age_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    age_cat = if_else(is.na(age_cat), "Total", age_cat)
  )

df_age_hiv_summary

```

```{r}

missed_scheduled_visit_by_age_plot <- ggplot(df_age_hiv_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.15)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

missed_scheduled_visit_by_age_plot

```

### Reduced ART Intake by Age Category

```{r}
df_age %>% group_by(age_cat,artstrbc) %>% 
  count()

df_age %>% group_by(age_cat,artstrac) %>% 
  count()
```

```{r}
df_age_artstr <- df_age %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_age_artstr_summary <- df_age_artstr %>%
  group_by(time, age_cat) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_age_artstr_totals <- df_age_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_age_artstr_summary <- bind_rows(df_age_artstr_summary, df_age_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    age_cat = if_else(is.na(age_cat), "Total", age_cat)
  )

df_age_artstr_summary

```

```{r}
reduced_art_intake_by_age_plot <- ggplot(df_age_artstr_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.15)) +
  labs(
    title = "Reduced ART Intake",
    x = "Age Category",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

reduced_art_intake_by_age_plot

```

```{r}

pa1 <- ggplot(df_age_artstr_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.15)) +
  labs(
    caption = "Reduced ART Intake",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )
pa1
```

```{r}
pa2 <- ggplot(df_age_hiv_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.15)) +
  labs(
    caption = "Missed Scheduled Visits",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

pa2
```

```{r}
pa3 <- ggplot(df_age_artrun_summary, aes(x = age_cat, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.12)) +
  labs(
    caption = "Run Out of ART",
    x = "Age Category",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, face = "bold", size = 10),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

pa3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pa1 + pa2)/pa3
```

# ART Duration

```{r}
df_dur <- rakai %>% 
  select(artyrs,artrunbc,artrunac,
         hivac,hivbc,copies,new_copies,artstrac,artstrbc) %>% 
  filter(hivac !=8, hivbc!=8,artrunbc!=8,artstrac!=8,artstrbc!=8,artrunac!=8) %>% 
 mutate(
  art_duration = case_when(
     artyrs >= 2 &  artyrs <= 5 ~ "2-5 years",
    artyrs > 5 ~ ">5 years",
    .default =  "<2 years"
  ) %>% 
    fct_relevel("<2 years","2-5 years") %>% 
    ff_label("Time on ART"),
  
    hivac = if_else(hivac ==1, "Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
      as_factor(),
   
     hivbc = if_else(hivbc ==1,"Yes","No") %>% 
    ff_label("Missed scheduled visit for HIV care") %>% 
    as_factor(),
 
     artrunac = if_else(artrunac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
 
   artrunbc = if_else(artrunbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Run out of ART before next refill"),
  
  artstrac = if_else(artstrac ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply"),
  
  artstrbc = if_else(artstrbc ==1,"Yes","No") %>% 
    as_factor() %>% 
    ff_label("Taken ART pills less frequently / in smaller
amounts to conserve supply")
  ) %>% 
  select(-artyrs)

```

```{r}
# df_dur
```

```{r}
df_dur %>% group_by(art_duration,artstrbc) %>% 
  count()

df_dur %>% group_by(art_duration,artstrac) %>% 
  count()
```

### Reduced ART intake by ART duration

```{r}
df_dur_artstr <- df_dur %>%
  pivot_longer(
    cols = c(artstrbc, artstrac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_dur_artstr_summary <- df_dur_artstr %>%
  group_by(time, art_duration) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_artstr_totals <- df_dur_artstr %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_dur_artstr_summary <- bind_rows(df_dur_artstr_summary, df_dur_artstr_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    
    art_duration = if_else(is.na(art_duration), "Total", art_duration) %>% 
      fct_relevel("<2 years","2-5 years"),
    lower = if_else(lower < 0,0,lower)
  )

df_dur_artstr_summary


```

```{r}
reduced_art_intake_by_duration_plot <- ggplot(df_dur_artstr_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Reduced ART Intake",
    x = "ART Duration",
    y = "Proportion of Individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

reduced_art_intake_by_duration_plot

```

### Run out of ART by ART Duration

```{r}
df_dur %>% group_by(art_duration,artrunbc) %>% 
  count()

df_dur %>% group_by(art_duration,artrunac) %>% 
  count()
```

```{r}
df_dur_artrun <- df_dur %>%
  mutate(
    artrunbc = as.character(artrunbc),
    artrunac = as.character(artrunac)
  ) %>%
  pivot_longer(
    cols = c(artrunbc, artrunac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_dur_artrun_summary <- df_dur_artrun %>%
  group_by(time, art_duration) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_artrun_totals <- df_dur_artrun %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_artrun_summary <- bind_rows(df_dur_artrun_summary, df_dur_artrun_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    art_duration = if_else(is.na(art_duration), "Total", art_duration)%>% 
      fct_relevel("<2 years","2-5 years"),
    lower = if_else(lower < 0,0,lower)
  )

df_dur_artrun_summary

```

```{r}
run_out_of_art_by_duration_plot <- ggplot(df_dur_artrun_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Run Out of ART",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

run_out_of_art_by_duration_plot

```

### Missed Scheduled visit by ART Duration

```{r}
df_dur %>% group_by(art_duration,hivbc) %>% 
  count()

df_dur %>% group_by(art_duration,hivac) %>% 
  count()
```

```{r}
df_dur_hiv <- df_dur %>%
  mutate(
    hivbc = as.character(hivbc),
    hivac = as.character(hivac)
  ) %>%
  pivot_longer(
    cols = c(hivbc, hivac),
    names_to = "variable",
    values_to = "response"
  ) %>%
  mutate(
    time = if_else(grepl("bc$", variable), "Before Covid-19", "After Covid-19")
  )

df_dur_hiv_summary <- df_dur_hiv %>%
  group_by(time, art_duration) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

df_dur_hiv_totals <- df_dur_hiv %>%
  group_by(time) %>%
  summarise(
    n_yes = sum(response == "Yes", na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) 

df_dur_hiv_summary <- bind_rows(df_dur_hiv_summary, df_dur_hiv_totals) %>%
  mutate(
    proportion = n_yes / n,
    se = sqrt(proportion * (1 - proportion) / n),
    lower = proportion - 1.96 * se,
    upper = proportion + 1.96 * se
  ) %>% 
  mutate(
    time = as_factor(time) %>% 
      fct_relevel("Before Covid-19"),
    art_duration = if_else(is.na(art_duration), "Total", art_duration)%>% 
      fct_relevel("<2 years","2-5 years"),
    lower = if_else(lower < 0,0,lower)
  )

df_dur_hiv_summary

```

```{r}
missed_scheduled_visit_by_duration_plot <- ggplot(df_dur_hiv_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 12),
    axis.title.y = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 10),
    legend.position = "top"
  )

missed_scheduled_visit_by_duration_plot

```

```{r}
pd1 <- ggplot(df_dur_artstr_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Reduced ART Intake",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pd1
```

```{r}
pd2 <- ggplot(df_dur_hiv_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Missed Scheduled Visits",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pd2
```

```{r}
pd3 <- ggplot(df_dur_artrun_summary, aes(x = art_duration, y = proportion, fill = time)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.5) +
  geom_errorbar(
    aes(ymin = lower, ymax = upper),
    position = position_dodge(width = 0.7),
    width = 0.2,
    size = 1
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 0.20)) +
  labs(
    title = "Run Out of ART",
    x = "ART Duration",
    y = "Proportion of individuals",
    fill = "Time"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    axis.title.x = element_text(face = "bold", size = 10),
    axis.title.y = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(size = 10),
    legend.position = c(0, 1), 
    legend.justification = c(0, 1),
    legend.direction = "horizontal"
  )

pd3
```

```{r}
#| fig-width: 10
#| fig-height: 10

### Combined plot
(pd1 + pd2)/pd3
```
